<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:MyProject"
             xmlns:local="clr-namespace:MyProject"
             x:Class="MyProject.MainPage"
             Padding="10">

    <ContentPage.Resources>
        <ResourceDictionary>
            <local:BoolToStarConverter x:Key="BoolToStarConverter" />
            <local:InverseBoolConverter x:Key="InverseBoolConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Grid to hold CollectionView and overlay -->
    <Grid>

        <!-- Main CollectionView for movie list -->
        <CollectionView x:Name="MoviesCollectionView"
                        ItemsSource="{Binding FilteredMovies}"
                        SelectionMode="Single"
                        SelectionChanged="CollectionView_SelectionChanged"
                        VerticalOptions="FillAndExpand">

            <!-- Vertical layout with spacing between movies -->
            <CollectionView.ItemsLayout>
                <LinearItemsLayout Orientation="Vertical" ItemSpacing="10"/>
            </CollectionView.ItemsLayout>

            <!-- HEADER: all content above the movie list -->
            <CollectionView.Header>
                <StackLayout Spacing="15">

                    <!-- Header -->
                    <StackLayout Spacing="4" HorizontalOptions="Center" Margin="0,10">
                        <Label Text="🎬 Movie Explorer" FontSize="26" FontAttributes="Bold" HorizontalOptions="Center"/>
                        <Label Text="Discover, rate &amp; favorite your movies" FontSize="13" Opacity="0.7" HorizontalOptions="Center"/>
                    </StackLayout>

                    <!-- Search Bar + Director Filter -->
                    <StackLayout Spacing="10">
                        <SearchBar x:Name="MovieSearchBar"
                                   Placeholder="Search movies..."
                                   TextChanged="SearchBar_TextChanged"/>
                        <StackLayout Orientation="Horizontal" Spacing="10">
                            <Label Text="Director:" VerticalOptions="Center"/>
                            <Entry x:Name="DirectorFilterEntry"
                                   Placeholder="Filter by director..."
                                   TextChanged="DirectorFilterEntry_TextChanged"
                                   HorizontalOptions="FillAndExpand"/>
                        </StackLayout>
                    </StackLayout>

                    <!-- Sort Picker + Favorites Only -->
                    <StackLayout Orientation="Horizontal"
                                 VerticalOptions="Center"
                                 Spacing="10">

                        <Picker x:Name="SortPicker"
                                Title="Sort by"
                                SelectedIndexChanged="SortPicker_SelectedIndexChanged"
                                WidthRequest="120">
                            <Picker.ItemsSource>
                                <x:Array Type="{x:Type x:String}">
                                    <x:String>Rating</x:String>
                                    <x:String>Year</x:String>
                                    <x:String>Title</x:String>
                                </x:Array>
                            </Picker.ItemsSource>
                        </Picker>

                        <Label Text="Favorites Only" VerticalOptions="Center"/>
                        <Switch IsToggled="{Binding ShowFavoritesOnly}" 
                                VerticalOptions="Center" 
                                SemanticProperties.Hint="Show only favorite movies"/>
                    </StackLayout>

                    <!-- Scrollable Buttons Row -->
                    <ScrollView Orientation="Horizontal" HorizontalScrollBarVisibility="Always">
                        <StackLayout Orientation="Horizontal" Spacing="10">

                            <Button Text="{Binding SortOrderText}"
                                    Clicked="SortOrderButton_Clicked"
                                    SemanticProperties.Hint="Toggle sort order ascending/descending"/>

                            <Button Text="📜 History"
                                    Clicked="HistoryButton_Clicked"
                                    SemanticProperties.Hint="View your movie history"/>

                            <Button Text="📊 View Statistics"
                                    Clicked="StatisticsButton_Clicked"
                                    SemanticProperties.Hint="View movie statistics"/>
                        </StackLayout>
                    </ScrollView>

                    <!-- TOP 10 MOVIES HEADER -->
                    <Label Text="🔥 Top 10 Movies" 
                           FontSize="20" 
                           FontAttributes="Bold"
                           HorizontalOptions="Start" 
                           Margin="10,0,0,5"/>

                    <!-- TOP 10 MOVIES COLLECTIONVIEW -->
                    <CollectionView ItemsSource="{Binding TopMovies}" 
                                    HeightRequest="180"
                                    HorizontalScrollBarVisibility="Never"
                                    Margin="10,0,0,10">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="15"/>
                        </CollectionView.ItemsLayout>

                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame Padding="10" CornerRadius="12"
                                       Background="{DynamicResource CardBackgroundBrush}" 
                                       HasShadow="True"
                                       WidthRequest="130">

                                    <!-- Make Top 10 item tappable -->
                                    <Frame.GestureRecognizers>
                                        <TapGestureRecognizer
                                            Tapped="MovieFrame_Tapped"
                                            NumberOfTapsRequired="1" />
                                    </Frame.GestureRecognizers>

                                    <!-- Frame content -->
                                    <StackLayout>
                                        <Label Text="{Binding emoji}" FontSize="40" HorizontalOptions="Center"/>
                                        <Label Text="{Binding title}" FontSize="14" FontAttributes="Bold" HorizontalOptions="Center" LineBreakMode="TailTruncation"/>
                                        <Label Text="{Binding rating, StringFormat='⭐ {0:F1}'}" FontSize="12" HorizontalOptions="Center"/>
                                        <Label Text="{Binding year}" FontSize="12" HorizontalOptions="Center"/>
                                    </StackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                </StackLayout>
            </CollectionView.Header>

            <!-- Main movie list -->
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame CornerRadius="12" Padding="10" HasShadow="True" Background="{DynamicResource CardBackgroundBrush}">
                        <Frame.GestureRecognizers>
                            <TapGestureRecognizer Tapped="MovieFrame_Tapped" NumberOfTapsRequired="1"/>
                        </Frame.GestureRecognizers>
                        <Grid ColumnSpacing="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Emoji -->
                            <Label ClassId="MovieEmojiLabel" Text="{Binding emoji}" FontSize="30" VerticalOptions="Center" Grid.Column="0"/>

                            <!-- Movie Details -->
                            <StackLayout Orientation="Vertical" Spacing="2" Grid.Column="1">
                                <Label Text="{Binding title}" FontAttributes="Bold" />
                                <Label Text="{Binding year}" FontSize="12" />
                                <Label Text="{Binding director}" FontSize="12" />
                                <Label Text="{Binding rating}" FontSize="12" />
                                <Label Text="{Binding genreString}" FontSize="12" />
                            </StackLayout>

                            <!-- Favorite button -->
                            <Button Text="{Binding IsFavorite, Converter={StaticResource BoolToStarConverter}}"
                                    Clicked="FavoriteButton_Clicked"
                                    FontSize="20"
                                    VerticalOptions="Center"
                                    HorizontalOptions="End"
                                    Grid.Column="2"
                                    SemanticProperties.Hint="Mark this movie as favorite"/>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <!-- EMPTY STATE -->
            <CollectionView.EmptyView>
                <StackLayout HorizontalOptions="Center" VerticalOptions="Center" Spacing="10">
                    <Label Text="😢 No movies found." FontSize="16"/>
                    <Label Text="⭐ No favorites yet." FontSize="16" IsVisible="{Binding HasFavorites, Converter={StaticResource InverseBoolConverter}}" />
                </StackLayout>
            </CollectionView.EmptyView>

        </CollectionView>

        <!-- HINT OVERLAY -->
        <Frame IsVisible="False"
               x:Name="HintFrame"
               BackgroundColor="#333"
               Padding="5"
               CornerRadius="5"
               HasShadow="False"
               HorizontalOptions="Center"
               VerticalOptions="Start"
               TranslationY="-40"
               Opacity="0.8">
            <Label x:Name="HintLabel" Text="" TextColor="White"/>
        </Frame>

    </Grid>

</ContentPage>



